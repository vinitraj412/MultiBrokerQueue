version: '3.9'
services:
    reverse_proxy:
        image: nginx
        container_name: reverse_proxy
        volumes:
            - ./nginx.conf:/etc/nginx/nginx.conf
        ports:
            - 8080:80
        deploy:
        networks:       
            - custom
        depends_on:
            - read_manager_one
            - read_manager_two
    
    write_manager:
        image: mbq:latest
        container_name: write_manager
        hostname: write_manager
        deploy: 
            replicas: 1
        networks:       
            - custom
        entrypoint: python
        command: ./ServiceProviders/WMWrapper.py

    read_manager_one:
        image: mbq:latest
        container_name: read_manager_one
        deploy:
            replicas: 1
        networks:       
            - custom
        entrypoint: python
        command: ./ServiceProviders/RMWrapper.py
        hostname: read_manager_one
        depends_on:
            - main_db_one
        environment:
            - DB_NAME=main_db_one

    read_manager_two:
        image: mbq:latest
        container_name: read_manager_two
        deploy:
            replicas: 1
        networks:       
            - custom
        entrypoint: python
        command: ./ServiceProviders/RMWrapper.py
        hostname: read_manager_two
        depends_on:
            - main_db_one
        environment:
            - DB_NAME=main_db_one
    
    broker_one:
        image: mbq:latest
        build: ./broker
        container_name: broker_one
        networks:       
            - custom
        restart: always
        hostname: broker_one
        depends_on:
            - db_one
        environment:
            - DB_NAME=db_one
        entrypoint: python
        command: ./Brokers/BrokerWrapper.py

    broker_two: 
        image: mbq:latest
        container_name: broker_two
        networks:       
            - custom
        restart: always
        hostname: broker_two
        depends_on:
            - db_two
        environment:
            - DB_NAME=db_two
        entrypoint: python
        command: ./Brokers/BrokerWrapper.py
    
    broker_three: 
        image: mbq:latest
        container_name: broker_three
        networks:       
            - custom
        restart: always
        hostname: broker_three
        depends_on:
            - db_three
        environment:
            - DB_NAME=db_three
        entrypoint: python
        command: ./Brokers/BrokerWrapper.py

    main_db_one: 
        image: postgres:13
        container_name: main_db_one
        restart: always
        volumes:
                - ./data:/var/lib/postgresql/data
        hostname: main_db_one
        environment:
                - 'POSTGRES_PASSWORD=postgres'
                - 'POSTGRES_DB=main_db_one'
        networks:       
            - custom

    main_db_two: 
        image: postgres:13
        container_name: main_db_two
        restart: always
        volumes:
                - ./data:/var/lib/postgresql/data
        hostname: main_db_two
        environment:
                - 'POSTGRES_PASSWORD=postgres'
                - 'POSTGRES_DB=main_db_two'
        networks:       
            - custom

    db_one:
        image: postgres:13
        container_name: db_one
        restart: always
        volumes:
                - ./data:/var/lib/postgresql/data
        hostname: db_one
        environment:
                - 'POSTGRES_PASSWORD=postgres'
                - 'POSTGRES_DB=db_one'
        networks:       
            - custom
        
    db_two:
        image: postgres:13
        container_name: db_two
        restart: always
        volumes:
                - ./data:/var/lib/postgresql/data
        hostname: db_two
        environment:
                - 'POSTGRES_PASSWORD=postgres'
                - 'POSTGRES_DB=db_two'
        networks:       
            - custom
    db_three:
        image: postgres:13
        container_name: db_three
        restart: always
        volumes:
                - ./data:/var/lib/postgresql/data
        hostname: db_three
        environment:
                - 'POSTGRES_PASSWORD=postgres'
                - 'POSTGRES_DB=db_three'
        networks:       
            - custom
        
networks:
    custom: {}